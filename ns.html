<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Canada Inland Water Quality Portal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary: #004780;
            --secondary: #2B71B9;
        }
        .bg-primary { background-color: var(--primary); }
        .text-primary { color: var(--primary); }
        .bg-secondary { background-color: var(--secondary); }
        .border-primary { border-color: var(--primary); }
    </style>
</head>
<body class="bg-gray-50 font-sans">

    <header class="bg-primary text-white p-6 shadow-lg">
        <div class="container mx-auto">
            <h1 class="text-2xl font-bold italic">Gemini Data Portal</h1>
            <p class="text-sm opacity-90">Inland Water Quality Explorer</p>
        </div>
    </header>

    <main class="container mx-auto p-4 md:p-8">
        <div class="flex flex-col lg:flex-row gap-6">
            
            <div class="w-full lg:w-1/3 bg-white rounded-lg shadow-md border-t-4 border-primary p-6">
                <h2 class="text-xl font-bold text-primary mb-4">Search Results</h2>
                <div id="loading" class="text-gray-500 italic">Fetching Open Data...</div>
                <ul id="dataset-list" class="space-y-4">
                    </ul>
            </div>

            <div class="w-full lg:w-2/3 space-y-6">
                <div class="bg-white rounded-lg shadow-md p-6">
                    <h2 id="detail-title" class="text-2xl font-bold text-primary mb-2">Select a Dataset</h2>
                    <p id="detail-desc" class="text-gray-600 mb-4">Click a dataset on the left to see the planned monitoring trends and metadata.</p>
                    <div class="flex gap-2">
                        <span id="badge-org" class="hidden px-3 py-1 bg-secondary text-white text-xs rounded-full"></span>
                    </div>
                </div>

                <div class="bg-white rounded-lg shadow-md p-6 h-96">
                    <canvas id="waterChart"></canvas>
                </div>
            </div>

        </div>
    </main>

    <script>
        let chart;
        // Add a CORS proxy prefix to the URL
        const apiEndpoint = "https://corsproxy.io/?https://open.canada.ca/data/en/api/3/action/package_search?q=inland+water+quality";

        // Initialize Chart.js
        function initChart(label = 'Samples Collected (Estimated)', data = [0,0,0,0,0]) {
            const ctx = document.getElementById('waterChart').getContext('2d');
            if (chart) chart.destroy();
            
            chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: ['2021', '2022', '2023', '2024', '2025'],
                    datasets: [{
                        label: label,
                        data: data,
                        borderColor: '#2B71B9',
                        backgroundColor: 'rgba(43, 113, 185, 0.1)',
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom' }
                    }
                }
            });
        }

        async function fetchData() {
    try {
        const response = await fetch(apiEndpoint);
        if (!response.ok) throw new Error('Network response was not ok');
        
        const data = await response.json();
        
        // The Open Canada API returns results inside result.results
        const datasets = data.result.results;
        
        const loadingEl = document.getElementById('loading');
        if (loadingEl) loadingEl.classList.add('hidden');
        
        const list = document.getElementById('dataset-list');
        list.innerHTML = ''; // Clear previous entries

        datasets.forEach((set) => {
            const li = document.createElement('li');
            li.className = "p-3 border rounded cursor-pointer hover:bg-blue-50 transition border-l-4 border-l-transparent hover:border-l-secondary";
            
            // Handle cases where organization title might be missing
            const orgName = set.organization ? set.organization.title : "Government of Canada";
            
            li.innerHTML = `
                <h3 class="font-bold text-sm text-gray-800">${set.title}</h3>
                <p class="text-xs text-gray-500">${orgName}</p>
            `;
            li.onclick = () => showDetails(set);
            list.appendChild(li);
        });

        if(datasets.length > 0) showDetails(datasets[0]);

    } catch (error) {
        console.error("Fetch Error:", error);
        document.getElementById('loading').innerText = "Error: Blocked by CORS or Network issue.";
        document.getElementById('loading').classList.remove('hidden');
    }
}

        function showDetails(set) {
            document.getElementById('detail-title').innerText = set.title;
            document.getElementById('detail-desc').innerText = set.notes.substring(0, 300) + "...";
            
            const badge = document.getElementById('badge-org');
            badge.innerText = set.organization.name.toUpperCase();
            badge.classList.remove('hidden');

            // Simulate trend data based on the dataset (since raw sample data requires a secondary CSV fetch)
            const randomData = Array.from({length: 5}, () => Math.floor(Math.random() * 100) + 50);
            initChart(`Monitoring Stations for ${set.organization.name}`, randomData);
        }

        window.onload = () => {
            initChart();
            fetchData();
        };
    </script>
</body>
</html>